name: windows-release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      runtime:
        description: "Runtime Identifier"
        required: false
        default: "win-x64"
        type: choice
        options:
          - "win-x64"
          - "win-arm64"

permissions:
  contents: write

jobs:
  build-test-publish:
    runs-on: windows-latest
    env:
      DOTNET_NOLOGO: "1"
      DOTNET_CLI_TELEMETRY_OPTOUT: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Install MAUI Workloads
        run: dotnet workload install maui maui-windows

      - name: Restore
        run: dotnet restore GcExtensionAuditMaui.sln

      - name: Test
        run: dotnet test GcExtensionAuditMaui.sln -c Release -f net9.0-windows10.0.19041.0

      - name: Publish (English only)
        shell: pwsh
        run: |
          $runtime = "${{ inputs.runtime }}"
          if ([string]::IsNullOrWhiteSpace($runtime)) { $runtime = "win-x64" }
          .\scripts\publish-windows.ps1 -RuntimeIdentifier $runtime -EnglishOnly

      - name: Package Artifact
        id: package
        shell: pwsh
        run: |
          $distRoot = Join-Path $env:GITHUB_WORKSPACE "dist"
          if (-not (Test-Path -LiteralPath $distRoot)) { throw "dist folder not found." }
          $latest = Get-ChildItem -LiteralPath $distRoot -Directory | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $latest) { throw "No publish output found in dist." }
          $tag = "${{ github.ref_name }}"
          if ([string]::IsNullOrWhiteSpace($tag)) { $tag = "build-${{ github.run_number }}" }
          $zipName = "GcExtensionAuditMaui_$tag_$($latest.Name).zip"
          $zipPath = Join-Path $distRoot $zipName
          if (Test-Path -LiteralPath $zipPath) { Remove-Item -LiteralPath $zipPath -Force }
          Compress-Archive -Path (Join-Path $latest.FullName "*") -DestinationPath $zipPath
          "zip_path=$zipPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload Release Asset
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.package.outputs.zip_path }}

      - name: Upload Workflow Artifact
        if: "!startsWith(github.ref, 'refs/tags/')"
        uses: actions/upload-artifact@v4
        with:
          name: windows-publish
          path: ${{ steps.package.outputs.zip_path }}
